<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pricing Debug Tool</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { padding: 10px 20px; margin: 5px; background-color: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <h1>üîê Pricing Authentication Debug Tool</h1>
    
    <div class="section">
        <h2>1. Firebase Authentication Status</h2>
        <div id="auth-status">Checking...</div>
        <button onclick="checkAuth()">Check Auth Status</button>
    </div>
    
    <div class="section">
        <h2>2. API Test with Authentication</h2>
        <div id="api-test">Click "Test API" to check pricing data</div>
        <button onclick="testAPI()">Test API</button>
    </div>
    
    <div class="section">
        <h2>3. Manual Token Test</h2>
        <div id="token-test">Click "Test Token" to verify token is being sent</div>
        <button onclick="testToken()">Test Token</button>
    </div>

    <script type="module">
        // Import Firebase (you'll need to adjust the path)
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        
        // Firebase config (same as your app)
        const firebaseConfig = {
            apiKey: "AIzaSyBUrCGwe15aSuujsajtRE6YWPzr6M6xhEY",
            authDomain: "celeste-470811.firebaseapp.com",
            projectId: "celeste-470811",
            storageBucket: "celeste-470811.firebasestorage.app",
            messagingSenderId: "846811285865",
            appId: "1:846811285865:web:b9faec291b004de62e15f8"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        window.checkAuth = async function() {
            const statusDiv = document.getElementById('auth-status');
            
            try {
                const currentUser = auth.currentUser;
                
                if (currentUser) {
                    statusDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ User Authenticated</h3>
                            <p><strong>UID:</strong> ${currentUser.uid}</p>
                            <p><strong>Email:</strong> ${currentUser.email || 'None'}</p>
                            <p><strong>Phone:</strong> ${currentUser.phoneNumber || 'None'}</p>
                            <p><strong>Provider:</strong> ${currentUser.providerData[0]?.providerId || 'Unknown'}</p>
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div class="error">
                            <h3>‚ùå No User Authenticated</h3>
                            <p>Please sign in to your web app first, then refresh this page.</p>
                        </div>
                    `;
                }
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Auth Error</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        };
        
        window.testToken = async function() {
            const tokenDiv = document.getElementById('token-test');
            
            try {
                const currentUser = auth.currentUser;
                
                if (!currentUser) {
                    tokenDiv.innerHTML = '<div class="error">‚ùå No user authenticated</div>';
                    return;
                }
                
                const idToken = await currentUser.getIdToken();
                
                tokenDiv.innerHTML = `
                    <div class="success">
                        <h3>‚úÖ Token Retrieved</h3>
                        <p><strong>Token Length:</strong> ${idToken.length}</p>
                        <p><strong>Token Preview:</strong> ${idToken.substring(0, 50)}...</p>
                        <p><strong>Token Valid:</strong> ${idToken ? 'Yes' : 'No'}</p>
                    </div>
                `;
            } catch (error) {
                tokenDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Token Error</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        };
        
        window.testAPI = async function() {
            const apiDiv = document.getElementById('api-test');
            apiDiv.innerHTML = '<div class="warning">üîÑ Testing API...</div>';
            
            try {
                const currentUser = auth.currentUser;
                
                if (!currentUser) {
                    apiDiv.innerHTML = '<div class="error">‚ùå No user authenticated</div>';
                    return;
                }
                
                const idToken = await currentUser.getIdToken();
                
                // Test the API call
                const response = await fetch('/api/products?limit=3&include_pricing=true&include_categories=true&include_inventory=true&store_id=1&only_discounted=true', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    }
                });
                
                const data = await response.json();
                const products = data.data?.products || [];
                
                if (products.length > 0) {
                    const firstProduct = products[0];
                    const hasPricing = firstProduct.pricing !== null;
                    const hasInventory = firstProduct.inventory !== null;
                    
                    apiDiv.innerHTML = `
                        <div class="${hasPricing ? 'success' : 'error'}">
                            <h3>${hasPricing ? '‚úÖ' : '‚ùå'} API Test Results</h3>
                            <p><strong>Products returned:</strong> ${products.length}</p>
                            <p><strong>Pricing data:</strong> ${hasPricing ? 'Present' : 'NULL'}</p>
                            <p><strong>Inventory data:</strong> ${hasInventory ? 'Present' : 'NULL'}</p>
                            <p><strong>Response status:</strong> ${response.status}</p>
                            ${hasPricing ? '<p><strong>Sample pricing:</strong></p><pre>' + JSON.stringify(firstProduct.pricing, null, 2) + '</pre>' : ''}
                        </div>
                    `;
                } else {
                    apiDiv.innerHTML = '<div class="error">‚ùå No products returned</div>';
                }
                
            } catch (error) {
                apiDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå API Error</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        };
        
        // Auto-check auth on load
        window.checkAuth();
    </script>
</body>
</html>
